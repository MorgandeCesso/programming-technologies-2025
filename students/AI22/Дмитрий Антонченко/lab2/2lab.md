# Telegram бот с GPT-4 - Лабораторная работа №2

Чат-бот для Telegram, который использует OpenAI GPT-4o-mini для ответов на сообщения. Реализован на Python с использованием библиотеки Aiogram.

## Что умеет бот

- Отвечает на сообщения через GPT-4o-mini
- Запоминает имя пользователя и обращается к нему
- Сохраняет историю переписки в базу данных
- Поддерживает контекст диалога (последние 10 сообщений)
- Можно сбросить историю командой
- Распознает отправку картинок

## Технологии

- Python 3.12
- aiogram 3.24.0 (асинхронная работа с Telegram Bot API)
- OpenAI API (GPT-4o-mini)
- SQLite (для хранения истории)
- python-dotenv (переменные окружения)

## Установка

### Клонировать репозиторий

```bash
git clone <ваш-репозиторий>
cd lab2
```

### Создать виртуальное окружение

```bash
python -m venv venv
```

### Активировать окружение

Windows:
```bash
venv\Scripts\activate
```

Linux/MacOS:
```bash
source venv/bin/activate
```

### Установить библиотеки

```bash
pip install -r requirements.txt
```

### Настроить .env файл

Создайте файл `.env` в корне проекта:

```
BOT_TOKEN=ваш_токен_бота
OPENAI_API_KEY=ваш_ключ_openai
```

**Получить BOT_TOKEN:**
- Идем к @BotFather в Telegram
- Пишем /newbot
- Следуем инструкциям
- Копируем токен

**Получить OPENAI_API_KEY:**
- Регистрируемся на platform.openai.com
- Идем в API Keys
- Создаем новый ключ

### Запуск

```bash
python main.py
```

## Команды

- `/start` - начало работы с ботом
- `/resetcontext` - очистить историю сообщений
<img width="2106" height="164" alt="4" src="https://github.com/user-attachments/assets/9829828c-c459-4720-b8f4-3b368f3b545a" />

## Как работает

Запускаете бота, находите его в Telegram и начинаете писать. Бот отвечает через GPT-4o-mini, при этом помнит последние 10 сообщений из вашего диалога. Если нужно начать разговор заново - используйте `/resetcontext`. Можно также отправить картинку, бот распознает это (но не обрабатывает саму картинку нейронкой, просто пишет что получил фото).
<img width="2107" height="1367" alt="3" src="https://github.com/user-attachments/assets/b3aacee3-f721-4795-9ea0-fa0f7487874d" />
<img width="2108" height="1361" alt="6" src="https://github.com/user-attachments/assets/2c3e4cb7-3e53-492c-a6c3-abdbb4ac6c17" />
<img width="2109" height="1364" alt="7" src="https://github.com/user-attachments/assets/185deadf-c445-42bf-a3a8-21c719aa3094" />


## Реализованные задания

В рамках лабораторной работы выполнены все 6 заданий:

1. Добавлен системный промпт (настроен дружелюбный тон общения)
2. Бот знает имя пользователя и использует его в ответах
3. Добавлена база данных SQLite для хранения сообщений
4. Реализована поддержка контекста (последние 10 сообщений передаются в GPT)
5. Команда `/resetcontext` для сброса истории
6. Поддержка отправки изображений (бот отвечает текстом что получил картинку)

## Детали реализации

### Системный промпт

В `utils/gpt.py` настроен промпт, который делает бота вежливым и дружелюбным. Он общается на русском и обращается к пользователю по имени.
<img width="2026" height="682" alt="5" src="https://github.com/user-attachments/assets/8778931a-3e40-4c74-9a20-db3a3b8550c4" />

### База данных

Используется SQLite с одной таблицей `messages`:
- id - автоинкремент
- user_id - telegram id пользователя
- user_name - имя
- role - user или assistant
- content - текст сообщения

Каждый пользователь имеет свою независимую историю.

### Контекст

Функция `get_last_messages()` в `db.py` достает последние 10 записей для конкретного пользователя. Эта история передается в GPT вместе с новым сообщением, чтобы модель понимала контекст разговора.

### Асинхронность

Весь код асинхронный (async/await), так как aiogram 3.x полностью асинхронный. Используется asyncio для запуска бота.

## Полезные ссылки

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [OpenAI API Docs](https://platform.openai.com/docs/)
- [Aiogram 3 Documentation](https://docs.aiogram.dev/)
